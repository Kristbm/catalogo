<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Confitería Roray</title>
    <!-- Enlaces a Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Enlaces a Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<style>
    ::-webkit-scrollbar {
        display: none;
    }

    .product-card {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-bottom: 20px;
        display: flex;
    }

    .product-card img {
        width: 150px;
        height: 150px;
        border-radius: 0.25rem 0 0 0.25rem;
    }

    .product-card .card-body {
        flex: 1;
        padding: 20px;
    }

    .product-card h5 {
        font-size: 1.25rem;
        margin-bottom: 10px;
    }

    .product-card .price {
        font-size: 1rem;
        color: #007bff;
        margin-bottom: 5px;
    }

    .product-card .price-bolivar {
        font-size: 0.9rem;
        color: #28a745;
        margin-bottom: 5px;
    }

    .product-card .quantity {
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    .product-card .quantity-bulk {
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    /* Estilos para pantalla pequeña (celular) */
    @media (max-width: 575.98px) {
        .product-card img {
            width: 155px;
        }

        .product-card .price,
        .product-card .price-bolivar,
        .product-card .quantity,
        .product-card .quantity-bulk {
            font-size: 0.8rem;
        }
    }
</style>

<body>
    <!-- Título y Navbar -->
    <div class="container mb-4">
        <h1 class="mt-5 mb-4 text-center">Catálogo de Productos</h1>
        <nav class="navbar navbar-expand-md navbar-light bg-light mb-2 p-3">
            <div class="container justify-content-center">
                <!-- Formulario para seleccionar la categoría -->
                <select id="categoria" class="form-control select-2" name="categoria">
                    <option value="">Todos</option>
                    <option value="galleta">Galletas</option>
                    <option value="chicle">Chicles</option>
                    <option value="caramelo">Caramelos</option>
                    <option value="gomita">Gomitas</option>
                </select>
                <!-- Mostrar la cantidad de productos -->
                <span id="cantidad-productos"></span>
            </div>
        </nav>

        <!-- Buscador -->
        <div class="row mt-4 justify-content-center">
            <div class="col-md-6">
                <form class="form-inline">
                    <input id="search" class="form-control w-100 mb-3" type="search" placeholder="Buscar"
                        aria-label="Search">
                </form>
            </div>
        </div>
    </div>

    <!-- Estructura de cards para mostrar los resultados -->
    <div id="results" class="container mt-4">
        <div class="row">
            <!-- Los resultados se cargarán aquí -->
        </div>
    </div>

    <!-- Boostrap y jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            $(document).keydown(function (event) {
                if (event.ctrlKey == true && (event.which == '61' || event.which == '107' || event.which == '173' || event.which == '109' || event.which == '187' || event.which == '189')) {
                    event.preventDefault();
                }
            });

            $(window).bind('mousewheel DOMMouseScroll', function (event) {
                if (event.ctrlKey == true) {
                    event.preventDefault();
                }
            });


            // Variable para almacenar los productos cargados en caché        
            var cachedProducts = [];

            // Función para cargar todos los productos al inicio
            function cargarProductos() {
                $.ajax({
                    url: 'src_catalogo_adm.php',
                    type: 'POST',
                    dataType: 'json',
                    success: function (response) {
                        // Ordenar los productos alfabéticamente por descripción
                        response.sort((a, b) => a.descripcion.localeCompare(b.descripcion));
                        // Mostrar los productos al cargar la página
                        mostrarProductos(response);
                        // Almacenar los productos en caché
                        cachedProducts = response;
                    },
                });
            }

            // Función para mostrar los productos en la página
            function mostrarProductos(productos) {
                var output = '';
                if (productos.length > 0) {
                    productos.forEach(function (producto) {
                        // Verificar si la descripción del producto contiene "oferta" o "promo"
                        if (producto.descripcion.toLowerCase().includes('oferta') || producto.descripcion.toLowerCase().includes('promo')) {
                            return; // No mostrar el producto si contiene "oferta" o "promo"
                        }

                        output += '<div class="col-md-4">';
                        output += '<div class="product-card">';

                        // Ruta de la imagen del producto
                        var imagePath = 'img/' + producto.codigo + '.png';
                        var defaultImagePath = 'img/000000001.png'; // Imagen predeterminada

                        // Añadir la imagen con un manejador de error
                        output += '<img src="' + imagePath + '" class="card-img-top" alt="' + producto.descripcion + '" onerror="this.onerror=null;this.src=\'' + defaultImagePath + '\';">';

                        output += '<div class="card-body">';
                        output += '<h5 class="card-title">' + producto.descripcion + '</h5>';
                        output += '<span class="badge badge-primary">Precio Unid: ' + producto.precio + '$</span>';
                        output += '<span class="badge badge-success">Precio al Mayor: ' + producto.preciomayor + '$</span>';
                        output += '<span class="badge badge-warning">Codigo: ' + producto.codigo + '</span><br>';
                        output += '<span class="badge badge-danger">Stock: ' + producto.stock + '</span><br>';
                        output += '<button class="btn btn-sm btn-primary add-image-btn mt-3" data-codigo="' + producto.codigo + '">Agregar Imagen</button><br>';
                        output += '<button class="btn btn-sm btn-secondary mt-1 mr-2 habilitar-btn" data-codigo="' + producto.codigo + '" data-habilitar="HABILITAR">HABILITAR</button><button class="btn btn-sm btn-secondary mt-1 habilitar-btn" data-codigo="' + producto.codigo + '" data-habilitar="DESHABILITAR">DESHABILITAR</button><br>';
                        output += '<span class="badge badge-warning">ESTADO: ' + producto.vista + '</span>';
                        output += '</div>';
                        output += '</div>';
                        output += '</div>';
                    });
                } else {
                    output += '<div class="col-md-12">';
                    output += '<p>No se encontraron resultados.</p>';
                    output += '</div>';
                }

                // Mostrar los productos en el contenedor
                $('#results .row').html(output);
            }


            /// Evento click para habilitar o deshabilitar el producto
            $(document).on('click', '.habilitar-btn', function () {
                var codigoProducto = $(this).data('codigo');
                var habilitar = $(this).data('habilitar'); // Obtener el estado de habilitación del botón

                // Definir el estado opuesto de habilitación para enviar al servidor
                var nuevoEstado = habilitar === 'HABILITAR' ? 1 : 0;

                $.ajax({
                    url: 'habilitar_producto.php',
                    type: 'POST',
                    data: { codigo: codigoProducto, estado: nuevoEstado },
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            alert('Producto ' + habilitar.toLowerCase() + ' exitosamente');
                        } else {
                            alert('Error: ' + response.message); // Muestra el mensaje de error
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error en la solicitud:', error);
                        alert('Error en la solicitud. Consulta la consola para más detalles.');
                    }
                });
            });



            // Función para cargar productos adicionales
            function cargarMasProductos() {
                // Realizar una solicitud AJAX para obtener más productos
                $.ajax({
                    url: 'src_catalogo_adm.php', // Ruta al archivo PHP que devuelve más productos
                    type: 'POST',
                    data: { offset: cachedProducts.length }, // Enviar un offset para obtener nuevos productos
                    dataType: 'json',
                    success: function (response) {
                        // Combinar los nuevos productos con los productos en caché
                        var nuevosProductos = response;
                        var productosCombinados = cachedProducts.concat(nuevosProductos);
                        // Mostrar los resultados actualizados
                        mostrarProductos(productosCombinados);
                        // Actualizar la caché con los productos combinados
                        cachedProducts = productosCombinados;
                    },
                    error: function (xhr, status, error) {
                        console.error('Error al cargar más productos:', error);
                    }
                });
            }


            // Función para verificar si el usuario ha llegado al final de la página
            function verificarScroll() {
                if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
                    // Si el usuario ha llegado al final de la página, cargar más productos
                    cargarMasProductos();
                }
            }

            // Evento de desplazamiento para verificar el scroll
            $(window).scroll(function () {
                verificarScroll();
            });

            // Función para filtrar productos por categoría y término de búsqueda
            function filtrarProductos() {
                var categoria = $('#categoria').val().toLowerCase();
                var searchTerm = $('#search').val().toLowerCase();

                // Definir las categorías y sus palabras clave asociadas
                var categorias = {
                    'todos': ['todos'],
                    'galleta': ['galleta', 'galletas'],
                    'chicle': ['chicle'],
                    'caramelo': ['dulce', 'caramelo'],
                    'gomita': ['gomitas', 'gomita']
                };

                // Obtener las palabras clave asociadas a la categoría seleccionada
                var palabrasClave = categorias[categoria] || [];

                // Obtener los productos de la caché
                var productosFiltrados = cachedProducts;

                // Filtrar por categoría si no es 'todos'
                if (categoria !== 'todos' && palabrasClave.length > 0) {
                    productosFiltrados = productosFiltrados.filter(function (producto) {
                        return palabrasClave.some(function (palabra) {
                            return producto.descripcion.toLowerCase().includes(palabra);
                        });
                    });
                }

                // Filtrar por término de búsqueda
                if (searchTerm !== '') {
                    productosFiltrados = productosFiltrados.filter(function (producto) {
                        return producto.descripcion.toLowerCase().includes(searchTerm);
                    });
                }

                // Mostrar los productos filtrados
                mostrarProductos(productosFiltrados);
            }

            // Evento para filtrar productos cuando cambia la categoría
            $('#categoria').change(filtrarProductos);

            // Evento para filtrar productos cuando cambia el término de búsqueda
            $('#search').on('input', filtrarProductos);

            // Deshabilitar la búsqueda al presionar Enter
            $('#search').on('keydown', function (event) {
                if (event.which === 13) {
                    event.preventDefault();
                }
            });
            // Cargar todos los productos al inicio
            cargarProductos();

            // Evento para cargar imagen cuando se hace clic en el botón "Agregar Imagen"
            $(document).on('click', '.add-image-btn', function () {
                var codigo = $(this).data('codigo');
                var inputFile = $('<input type="file">');

                // Abrir el selector de archivos cuando se hace clic en el botón
                inputFile.trigger('click');

                // Manejar el cambio de archivo seleccionado
                inputFile.on('change', function () {
                    var file = this.files[0];
                    var formData = new FormData();
                    formData.append('image', file, codigo + '.png'); // Cambia la extensión de acuerdo a tus necesidades

                    // Subir la imagen al servidor
                    $.ajax({
                        url: 'upload_img.php', // Cambia esto al nombre de tu script de carga de imágenes en el servidor
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            console.log('Imagen cargada exitosamente:', response);

                            // Recargar la lista de productos para mostrar la nueva imagen
                            cargarProductos();
                        },
                        error: function (xhr, status, error) {
                            console.error('Error al cargar la imagen:', error);
                        }
                    });
                });
            });
        });
    </script>
</body>

</html>